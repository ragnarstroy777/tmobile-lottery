# Механика и логика проекта «Розыгрыш»

Коротко: это офлайн/инхаус‑лототрон с 3D‑облаком карточек участников, по которым выполняется анимация «вращения шара» и выбор случайных победителей по настраиваемым призовым уровням. Состояние розыгрыша сохраняется на сервере и может экспортироваться в Excel.

## Архитектура
- Клиент (`product/src`): UI на Three.js (CSS3DRenderer) + TWEEN анимации, нативный JS + простые AJAX вызовы.
- Сервер (`server`): Express, чтение Excel c участниками, хранение состояния в JSON, экспорт результата в Excel.
- Конфигурация призов: `server/config.js` (уровни, количества, тексты, картинки), `EACH_COUNT` определяет количество победителей за один «пуск» для каждого уровня.

## Поток запуска UI
- Инициализация: `product/src/lottery/index.js:65` — `initAll()` запрашивает с бэкенда конфиг/состояние (`/getTempData`) и список участников (`/getUsers`).
- Построение карточек: `product/src/lottery/index.js:116` — создаются CSS3D‑карточки с ФИО, ID и отделом; раскладываются в таблицу и на сферу.
- Управление камерой: TrackballControls (вращение/зум/пан) + рендер CSS3D.
- Фон: звёздное поле на Canvas (`product/src/lottery/canvas.js`).
- Музыка: кнопка «Музыка» включает/пауза, с небольшой ротацией и автозапуском (если разрешено браузером).

## UI и управления
- Экран приветствия → «Перейти к розыгрышу» переводит сцену из таблицы в сферу.
- Панель розыгрыша:
  - «Начать розыгрыш» — запускает анимацию вращения шара и розыгрыш текущего уровня.
  - «Переразыграть» — повторно разыгрывает тот же уровень по текущему пулу.
  - «Экспортировать результаты» — сохраняет на сервере и скачивает Excel.
  - «Сброс» — очищает состояние (подтверждение).
- Левая панель призов показывает текущий уровень, прогресс (сколько осталось) и список уровней с миниатюрами.

## Призы, уровни и прогрессия
- Конфигурация: `server/config.js:1` — массив `prizes`. Тип `type=0` — «Специальный приз» (без ограничений по количеству, используется после исчерпания основных уровней).
- Количество победителей за пуск: `EACH_COUNT` — массив, индекс совпадает с индексом призового уровня в `prizes`.
- Активный уровень выбирается как «самый старший ещё не исчерпанный» при запуске (`product/src/lottery/index.js:83`).
- Обновление прогресса: `product/src/lottery/prizeList.js:204` — `setPrizeData(...)` пересчитывает и визуально обновляет прогресс‑бар и счётчик «осталось».

## Розыгрыш и анимации
- Запуск: по кнопке «Начать розыгрыш» устанавливается флаг «идёт розыгрыш» и запускается вращение сцены TWEEN‑анимацией (`product/src/lottery/index.js:388` → `rotateBall()`).
- Остановка: повторное нажатие останавливает TWEEN, промис завершается и начинается выбор победителей.
- Выбор победителей (`lottery()`):
  - Определяется `perCount`= `EACH_COUNT[currentPrizeIndex]`.
  - Берётся пул оставшихся участников `leftUsers`. Если людей меньше, чем надо, пул сбрасывается на полный список (возможен второй круг).
  - Генератор случайных чисел выбирает нужное количество записей, каждая вынутая запись удаляется из `leftUsers`, чтобы исключить повторы.
  - Для каждого победителя случайно выбирается видимая карточка и «подсвечивается», затем карточки победителей выезжают на передний план в один/два ряда (`selectCard(...)`).
- Подсказки/тосты: всплывающие сообщения «пузырьки» сопровождают ключевые события (старт, повтор, экспорт, поздравления).

## Исключение повторов и повторный розыгрыш
- База исключённых: сервер собирает два множества — `luckyData` (выигравшие) и `errorData` (те, кого нужно исключить при «Переразыграть»).
- Расчёт оставшихся: `server/server.js:200` → `getLeftUsers()` вычитает ID из обоих множеств.
- При «Переразыграть» текущие победители отправляются в `/errorData` и в следующем розыгрыше не участвуют.

## Сохранение состояния
- На каждом цикле до розыгрыша клиент шлёт `/saveData` для фиксации прошлых победителей.
- Сервер хранит JSON‑файлы в `server/cache`: `temp.json` (победители), `error.json` (исключения). См. `server/help.js`.
- При перезапуске сервера текущее состояние считывается и продолжает использоваться.

## Экспорт результатов
- Кнопка «Экспортировать результаты» вызывает `/export`.
- Формируется лист Excel (`Results`) с колонками `ID`, `Имя`, `Отдел`, и блоками по призовым уровням.
- Файл скачивается как `results.xlsx`.

## Данные участников
- Источник — `server/data/users.xlsx` (первая строка — заголовки, далее: `ID | Имя | Отдел`).
- Сервер при старте читает файл, перемешивает список участников (Fisher–Yates), и сохраняет в память.

## Важные точки в коде
- Клиентская инициализация: `product/src/lottery/index.js:65` (`initAll`).
- Создание карточки участника: `product/src/lottery/index.js:329` (`createCard`).
- Переход между раскладками (таблица/сфера): `product/src/lottery/index.js:356` (`transform`).
- Панель призов и прогресс: `product/src/lottery/prizeList.js:156` (`showPrizeList`), `product/src/lottery/prizeList.js:204` (`setPrizeData`).
- Серверные эндпоинты: `server/server.js:67` (`/getTempData`), `server/server.js:90` (`/getUsers`), `server/server.js:102` (`/saveData`), `server/server.js:120` (`/errorData`), `server/server.js:138` (`/export`).
- Работа с Excel и кешем: `server/help.js` (чтение/запись XLSX и JSON).

## Сборка и запуск
- Установка зависимостей:
  - Сервер: `cd server && npm i`
  - Клиент: `cd ../product && npm i`
- Сборка клиента: `npm run build` (включён флаг совместимости OpenSSL для Node 22+).
- Запуск: `npm run serve` (поднимет Express на `http://127.0.0.1:8888`).

## Расширение/кастомизация
- Добавление уровня приза: править `server/config.js` (элемент в `prizes` и соответствующий слот в `EACH_COUNT`).
- Замена логотипа/названия компании на карточке: `COMPANY` в `server/config.js`.
- Тексты UI/подсказок — в `product/src/index.html`, `product/src/lottery/index.js`, `product/src/lottery/prizeList.js`.

